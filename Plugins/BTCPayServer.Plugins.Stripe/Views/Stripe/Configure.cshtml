@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.Stripe.Services
@model BTCPayServer.Plugins.Stripe.PaymentHandler.StripePaymentMethodConfig
@{
    ViewData.SetActivePage("Stripe", "Stripe Settings", "Stripe");
    var webhookStatus = ViewBag.WebhookStatus as WebhookStatus;
}

<form method="post">
    <div class="sticky-header-setup"></div>
    <div class="sticky-header d-sm-flex align-items-center justify-content-between">
        <h2 class="mb-0">@ViewData["Title"]</h2>
        <div class="d-flex gap-3 mt-3 mt-sm-0">
            <button name="command" type="submit" value="test" class="btn btn-secondary">Test Connection</button>
            <button name="command" type="submit" value="save" class="btn btn-primary">Save</button>
        </div>
    </div>

    <partial name="_StatusMessage"/>

    <div class="row">
        <div class="col-xl-8 col-xxl-constrain">
            @if (Model.IsConfigured)
            {
                <div class="alert @(Model.IsTestMode ? "alert-warning" : "alert-info") mb-4">
                    <strong>@(Model.IsTestMode ? "Test Mode" : "Live Mode")</strong>:
                    @(Model.IsTestMode
                        ? "Using Stripe test API keys. Payments will not be real."
                        : "Using Stripe live API keys. Payments will be real.")
                </div>
            }

            <div class="form-group">
                <div class="d-flex align-items-center">
                    <input asp-for="Enabled" type="checkbox" class="btcpay-toggle me-2"/>
                    <label asp-for="Enabled" class="form-label mb-0">Enable Stripe Payments</label>
                </div>
                <span asp-validation-for="Enabled" class="text-danger"></span>
            </div>

            <h4 class="mt-4 mb-3">API Configuration</h4>

            @if (Model.IsConfigured)
            {
                <div class="alert alert-secondary mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>API Keys Configured</strong>
                            <p class="mb-0 small text-muted">
                                Publishable Key: <code>@Model.PublishableKey?[..Math.Min(12, Model.PublishableKey?.Length ?? 0)]...</code>
                            </p>
                        </div>
                        <button name="command" type="submit" value="clearcredentials" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Are you sure you want to clear your Stripe credentials? This will also delete the webhook from Stripe.');">
                            Clear Credentials
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="form-group">
                    <label asp-for="PublishableKey" class="form-label" data-required>Publishable Key</label>
                    <input asp-for="PublishableKey" type="text" class="form-control" placeholder="pk_live_... or pk_test_..."/>
                    <span asp-validation-for="PublishableKey" class="text-danger"></span>
                    <div class="form-text">
                        Your Stripe publishable API key (starts with pk_).
                        <a href="https://dashboard.stripe.com/apikeys" target="_blank" rel="noreferrer noopener">Get from Stripe Dashboard</a>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="SecretKey" class="form-label" data-required>Secret Key</label>
                    <input asp-for="SecretKey" type="password" class="form-control" placeholder="sk_live_... or sk_test_..."/>
                    <span asp-validation-for="SecretKey" class="text-danger"></span>
                    <div class="form-text">
                        Your Stripe secret API key (starts with sk_).
                        <a href="https://dashboard.stripe.com/apikeys" target="_blank" rel="noreferrer noopener">Get from Stripe Dashboard</a>
                    </div>
                </div>
            }

            <div class="form-group">
                <label asp-for="SettlementCurrency" class="form-label" data-required>Settlement Currency</label>
                <input asp-for="SettlementCurrency" type="text" class="form-control" placeholder="USD" maxlength="3" style="max-width: 100px;"/>
                <span asp-validation-for="SettlementCurrency" class="text-danger"></span>
                <div class="form-text">Currency code for Stripe charges (e.g., USD, EUR, GBP)</div>
            </div>

            <h4 class="mt-5 mb-3">Webhook Configuration</h4>

            @if (webhookStatus != null)
            {
                @if (webhookStatus.IsValid)
                {
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <vc:icon symbol="checkmark" />
                        <div class="ms-2">
                            <strong>Webhook Active</strong>
                            <p class="mb-0 small">
                                ID: <code>@webhookStatus.WebhookId</code>
                                @if (webhookStatus.HasSigningSecret)
                                {
                                    <span class="badge bg-success ms-2">Signing secret configured</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning ms-2">No signing secret</span>
                                }
                            </p>
                        </div>
                    </div>
                }
                else if (webhookStatus.IsConfigured)
                {
                    <div class="alert alert-warning" role="alert">
                        <strong>Webhook Issue: @webhookStatus.Status</strong>
                        @if (!string.IsNullOrEmpty(webhookStatus.Error))
                        {
                            <p class="mb-2 small">@webhookStatus.Error</p>
                        }
                        <p class="mb-0">
                            <button name="command" type="submit" value="registerwebhook" class="btn btn-sm btn-warning">
                                Re-register Webhook
                            </button>
                        </p>
                    </div>
                }
                else
                {
                    <div class="alert alert-info" role="alert">
                        <strong>Webhook not configured</strong>
                        <p class="mb-2 small">Webhooks provide reliable payment notifications. Without a webhook, payments are verified synchronously.</p>
                        <button name="command" type="submit" value="registerwebhook" class="btn btn-sm btn-info">
                            Register Webhook
                        </button>
                    </div>
                }
            }
            else if (!Model.IsConfigured)
            {
                <div class="alert alert-secondary" role="alert">
                    <p class="mb-0">Save your API keys first to configure webhooks.</p>
                </div>
            }

            <h4 class="mt-5 mb-3">Advanced Settings</h4>

            <div class="form-group">
                <label asp-for="StatementDescriptor" class="form-label">Statement Descriptor</label>
                <input asp-for="StatementDescriptor" type="text" class="form-control" maxlength="22"/>
                <span asp-validation-for="StatementDescriptor" class="text-danger"></span>
                <div class="form-text">Text that appears on customer bank statements (max 22 characters)</div>
            </div>

            <div class="form-group">
                <label asp-for="AdvancedConfig" class="form-label">Advanced Configuration (JSON)</label>
                <textarea asp-for="AdvancedConfig" class="form-control" rows="5" placeholder='{"payment_method_types": ["card"], "metadata": {"custom_field": "value"}}'></textarea>
                <span asp-validation-for="AdvancedConfig" class="text-danger"></span>
                <div class="form-text">
                    Optional JSON to customize PaymentIntent creation. Supported fields:
                    <code>payment_method_types</code>, <code>metadata</code>, <code>statement_descriptor_suffix</code>,
                    <code>capture_method</code>, <code>setup_future_usage</code>.
                    <a href="https://stripe.com/docs/api/payment_intents/create" target="_blank" rel="noopener">Stripe API docs</a>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" asp-for="WebhookId" />
    <input type="hidden" asp-for="WebhookSecret" />
</form>
