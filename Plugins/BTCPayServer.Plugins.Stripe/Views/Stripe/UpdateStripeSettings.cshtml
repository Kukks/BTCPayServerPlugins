@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.Stripe
@using BTCPayServer.Plugins.Stripe.PaymentHandler
@using BTCPayServer.Plugins.Stripe.Services
@model StripePaymentMethodConfig

@{
    ViewData.SetActivePage("Stripe", "Stripe Settings", "Stripe");
    var webhookStatus = ViewBag.WebhookStatus as WebhookStatus;
}

<form method="post" asp-action="Configure">
    <div class="sticky-header-setup"></div>
    <div class="sticky-header d-sm-flex align-items-center justify-content-between">
        <h2 class="mb-0">@ViewData["Title"]</h2>
        <div class="d-flex gap-3 mt-3 mt-sm-0">
            <button name="command" type="submit" value="test" class="btn btn-secondary">Test Connection</button>
            <button name="command" type="submit" value="save" class="btn btn-primary">Save</button>
        </div>
    </div>

    <partial name="_StatusMessage"/>

    @if (Model.IsTestMode)
    {
        <div class="alert alert-warning" role="alert">
            <h5 class="alert-heading">Test Mode Active</h5>
            <p class="mb-0">You are using test API keys. No real payments will be processed.</p>
        </div>
    }

    <div class="row">
        <div class="col-xl-8 col-xxl-constrain">
            <div class="form-group">
                <label asp-for="PublishableKey" class="form-label">Publishable Key</label>
                <input asp-for="PublishableKey" class="form-control" placeholder="pk_live_..." />
                <span asp-validation-for="PublishableKey" class="text-danger"></span>
                <div class="form-text">Your Stripe publishable API key. Starts with <code>pk_live_</code> or <code>pk_test_</code>.</div>
            </div>

            <div class="form-group">
                <label asp-for="SecretKey" class="form-label">Secret Key</label>
                <input asp-for="SecretKey" type="password" class="form-control" placeholder="sk_live_..." />
                <span asp-validation-for="SecretKey" class="text-danger"></span>
                <div class="form-text">Your Stripe secret API key. Starts with <code>sk_live_</code> or <code>sk_test_</code>. Keep this secure.</div>
            </div>

            <div class="form-group">
                <label asp-for="SettlementCurrency" class="form-label">Settlement Currency</label>
                <input asp-for="SettlementCurrency" class="form-control" style="max-width: 100px;" />
                <span asp-validation-for="SettlementCurrency" class="text-danger"></span>
                <div class="form-text">The currency Stripe will charge customers in (e.g., USD, EUR, GBP).</div>
            </div>

            <h4 class="mt-5 mb-3">Webhook Configuration</h4>

            @if (webhookStatus != null)
            {
                @if (webhookStatus.IsValid)
                {
                    <div class="alert alert-success d-flex align-items-center" role="alert">
                        <vc:icon symbol="checkmark" />
                        <div class="ms-2">
                            <strong>Webhook Active</strong>
                            <p class="mb-0 small">
                                ID: <code>@webhookStatus.WebhookId</code>
                                @if (webhookStatus.HasSigningSecret)
                                {
                                    <span class="badge bg-success ms-2">Signing secret configured</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning ms-2">No signing secret</span>
                                }
                            </p>
                        </div>
                    </div>
                }
                else if (webhookStatus.IsConfigured)
                {
                    <div class="alert alert-warning" role="alert">
                        <strong>Webhook Issue: @webhookStatus.Status</strong>
                        @if (!string.IsNullOrEmpty(webhookStatus.Error))
                        {
                            <p class="mb-2 small">@webhookStatus.Error</p>
                        }
                        <p class="mb-0">
                            <button name="command" type="submit" value="registerwebhook" class="btn btn-sm btn-warning">
                                Re-register Webhook
                            </button>
                        </p>
                    </div>
                }
                else
                {
                    <div class="alert alert-info" role="alert">
                        <strong>Webhook not configured</strong>
                        <p class="mb-2 small">Webhooks provide reliable payment notifications. Without a webhook, payments are verified synchronously.</p>
                        <button name="command" type="submit" value="registerwebhook" class="btn btn-sm btn-info">
                            Register Webhook
                        </button>
                    </div>
                }
            }
            else if (!Model.IsConfigured)
            {
                <div class="alert alert-secondary" role="alert">
                    <p class="mb-0">Save your API keys first to configure webhooks.</p>
                </div>
            }

            <h4 class="mt-5 mb-3">Advanced Settings</h4>

            <div class="form-group">
                <label asp-for="StatementDescriptor" class="form-label">Statement Descriptor</label>
                <input asp-for="StatementDescriptor" class="form-control" maxlength="22" />
                <span asp-validation-for="StatementDescriptor" class="text-danger"></span>
                <div class="form-text">Text that appears on your customer's bank statement. Maximum 22 characters.</div>
            </div>

            <div class="form-group">
                <div class="form-check">
                    <input asp-for="EnableApplePay" type="checkbox" class="form-check-input" />
                    <label asp-for="EnableApplePay" class="form-check-label">Enable Apple Pay</label>
                </div>
                <div class="form-text">Allow customers to pay with Apple Pay when available.</div>
            </div>

            <div class="form-group">
                <div class="form-check">
                    <input asp-for="EnableGooglePay" type="checkbox" class="form-check-input" />
                    <label asp-for="EnableGooglePay" class="form-check-label">Enable Google Pay</label>
                </div>
                <div class="form-text">Allow customers to pay with Google Pay when available.</div>
            </div>
        </div>
    </div>

    <input type="hidden" asp-for="WebhookId" />
    <input type="hidden" asp-for="WebhookSecret" />
</form>
