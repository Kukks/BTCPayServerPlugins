@using BTCPayServer.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.EntityFrameworkCore
@using Newtonsoft.Json.Linq
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="border-light">
    <div class="form-group">
        <label class="form-label">Destination Id</label>
        <input type="text" @bind="WorkingId" class="form-control"/>
        @if (InvalidId)
        {
            <span class="text-danger w-100">@IdValidationError</span>
        }
        <span class="form-text">An alias to reference in destinations of prisms.</span>
    </div>
    
    @if (WorkingCopy is not null)
    {
        <DestinationInput 
            @ref="DestinationInputRef"
            StoreId="@StoreId"
            InitialDestination="@WorkingCopy.Destination"
            InitialSatThreshold="@WorkingCopy.SatThreshold"
            InitialReserve="@WorkingCopy.Reserve"
            ValidateDestination="@ValidateDestination"
            OnChange="@OnDestinationInputChange"
            ShowThresholdAndReserve="true" />

        <div class="mt-3">
            <button type="button" class="btn btn-primary" @onclick="Update">@(string.IsNullOrEmpty(OriginalWorkingId) ? "Create" : "Update")</button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
            @if (!string.IsNullOrEmpty(OriginalWorkingId))
            {
                <button type="button" class="btn btn-outline-danger" @onclick="() => OnUpdate.InvokeAsync((OriginalWorkingId, null))">Remove</button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string StoreId { get; set; }

    private PrismDestination WorkingCopy { get; set; }
    private string WorkingId { get; set; }
    private string OriginalWorkingId { get; set; }

    private bool InvalidId { get; set; }
    private string IdValidationError { get; set; } = "Invalid";
    private bool Invalid { get; set; }
    
    private DestinationInput DestinationInputRef { get; set; }
    private DestinationInput.DestinationInputResult CurrentDestinationResult { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public Func<string, bool> ValidateDestination { get; set; }

    [Parameter]
    public Func<string, bool> ValidateId { get; set; }

    [Parameter]
    public PrismDestination Settings
    {
        get => WorkingCopy;
        set
        {
            WorkingCopy = JObject.FromObject(value ?? new PrismDestination()).ToObject<PrismDestination>();
            Invalid = false;
        }
    }

    [Parameter]
    public string Id
    {
        get => WorkingId;
        set
        {
            if (OriginalWorkingId != value)
            {
                WorkingId = value;
                OriginalWorkingId = value;
                InvalidId = false;
            }
        }
    }

    [Parameter]
    public EventCallback<(string Id, PrismDestination? Destination)> OnUpdate { get; set; }

    private void OnDestinationInputChange(DestinationInput.DestinationInputResult result)
    {
        CurrentDestinationResult = result;
        Invalid = !result.IsValid;
    }

    public async Task Update()
    {
        // Validate the ID
        InvalidId = false;
        IdValidationError = "Invalid";
        
        if (string.IsNullOrWhiteSpace(WorkingId))
        {
            InvalidId = true;
            IdValidationError = "Destination ID is required";
        }
        else if (ValidateId != null && !ValidateId.Invoke(WorkingId))
        {
            InvalidId = true;
            IdValidationError = "This ID is already in use";
        }

        // Validate the destination input
        var destResult = DestinationInputRef?.Validate();
        Invalid = destResult == null || !destResult.IsValid;

        if (Invalid || InvalidId)
        {
            return;
        }

        // Build the PrismDestination from the input result
        WorkingCopy.Destination = destResult.Destination;
        WorkingCopy.SatThreshold = destResult.SatThreshold;
        WorkingCopy.Reserve = destResult.Reserve;

        await OnUpdate.InvokeAsync((WorkingId, WorkingCopy));
    }

    private Task Cancel()
    {
        return OnCancel.InvokeAsync(null);
    }
}
