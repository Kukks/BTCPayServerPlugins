@using BTCPayServer.Lightning
@using BTCPayServer.Payments
@using BTCPayServer.Plugins.Prism.ViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@using LightningAddressData = BTCPayServer.Data.LightningAddressData
@inject SatBreaker SatBreaker
@inject EventAggregator EventAggregator

<div class="card mb-3">
    <div class="card-body">
        @if (IsWalletTransfer)
        {
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title mb-0">
                    <span class="badge bg-secondary me-2">@WalletPaymentMethod</span>
                    @if (!string.IsNullOrEmpty(WalletAmount))
                    {
                        <span>@WalletAmount sats</span>
                    }
                    else
                    {
                        <span class="text-muted">Full balance</span>
                    }
                    <span class="text-muted ms-2">— @GetScheduleDisplayText()</span>
                </h6>
                <div class="btn-group btn-group-sm">
                    @if (!ShouldShowEdit)
                    {
                        <button type="button" class="btn btn-outline-success" @onclick="SendNow" title="Execute this transfer immediately, ignoring the schedule">Send</button>
                    }
                    <button type="button" class="btn btn-outline-secondary" @onclick="ToggleEdit" title="Edit transfer settings">@(ShouldShowEdit ? "Done" : "Edit")</button>
                    <button type="button" class="btn btn-outline-danger" @onclick="RemoveSplit" title="Remove this wallet transfer">Remove</button>
                </div>
            </div>

            @if (ShouldShowEdit)
            {
                <div class="row mb-3 border-top pt-3 g-3">
                    <div class="col-md-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select form-select-sm" @bind="WalletPaymentMethod" @bind:after="UpdateWalletSource"
                                title="Which wallet balance to transfer from">
                            <option value="BTC-CHAIN">On-chain</option>
                            <option value="BTC-LN">Lightning</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Amount (sats)</label>
                        <input type="text" class="form-control form-control-sm" @bind="WalletAmount" @bind:after="UpdateWalletSource"
                               placeholder="Full balance"
                               title="Amount to transfer in satoshis. Leave empty to transfer the entire wallet balance."/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Frequency</label>
                        <select class="form-select form-select-sm" @bind="SelectedFrequency" @bind:after="OnFrequencyChanged"
                                title="How often should this transfer be executed">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        @if (SelectedFrequency == "Weekly")
                        {
                            <label class="form-label">Day of Week</label>
                            <select class="form-select form-select-sm" @bind="SelectedDayValue" @bind:after="UpdateWalletSource"
                                    title="Which day of the week to execute the transfer">
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        }
                        else if (SelectedFrequency == "Monthly")
                        {
                            <label class="form-label">Day of Month</label>
                            <select class="form-select form-select-sm" @bind="SelectedDayValue" @bind:after="UpdateWalletSource"
                                    title="Which day of the month to execute the transfer (1-31)">
                                @for (int i = 1; i <= 31; i++)
                                {
                                    <option value="@i">@i@GetOrdinalSuffix(i)</option>
                                }
                            </select>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="d-flex justify-content-between align-items-center mb-2">
                @if (ShouldShowEdit)
                {
                    <div class="flex-grow-1 me-2">
                        <SourceEditor 
                            Source="@Split.Source" 
                            SourceChanged="@OnSourceChanged"
                            PosApps="@PosApps"
                            LnAddresses="@LnAddresses" />
                        <ValidationMessage2 For="() => Split.Source" class="text-danger small"></ValidationMessage2>
                    </div>
                }
                else
                {
                    <h6 class="card-title mb-0 flex-grow-1">
                        <span class="badge bg-primary me-2">@GetSourceTypeBadge()</span>
                        <span>@GetSourceDisplayText()</span>
                    </h6>
                }
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" @onclick="ToggleEdit" title="Edit split settings">@(ShouldShowEdit ? "Done" : "Edit")</button>
                    <button type="button" class="btn btn-outline-danger" @onclick="RemoveSplit" title="Remove this split">Remove</button>
                </div>
            </div>
        }

        <div class="destinations-list">
            @if (!ShouldShowEdit)
            {
                @* Read-only view with friendly destination display *@
                @foreach (var destination in Split.Destinations)
                {
                    <div class="d-flex gap-2 mb-2 align-items-center">
                        <div class="flex-grow-1">
                            <DestinationDisplay 
                                Destination="@destination.Destination"
                                Destinations="@Destinations"
                                AvailableStores="@AvailableStores"
                                Truncate="true"
                                Clickable="@(Destinations?.ContainsKey(destination.Destination) == true)"
                                OnClick="@(d => StartEditingDestination(destination))" />
                        </div>
                        <span class="badge bg-secondary">@destination.Percentage%</span>
                    </div>
                }
            }
            else
            {
                @* Editable view *@
                @foreach (var destination in Split.Destinations)
                {
                    var destIndex = Split.Destinations.IndexOf(destination);
                    <div class="d-flex gap-2 mb-2 align-items-center">
                        @if (EditingDestinationIndex == destIndex)
                        {
                            @* Inline destination picker *@
                            <div class="flex-grow-1 border rounded p-2 bg-light">
                                <DestinationPicker
                                    StoreId="@StoreId"
                                    Destinations="@Destinations"
                                    AvailableStores="@AvailableStores"
                                    PaymentMethodFilter="@GetPaymentMethodFilter()"
                                    ValidateDestination="@ValidateDestination"
                                    SelectedDestination="@destination.Destination"
                                    AllowEdit="true"
                                    AllowSaveAsAlias="true"
                                    OnSelect="@(result => OnDestinationSelected(destination, result))"
                                    OnAliasChange="@OnAliasChanged"
                                    OnCancel="@(() => EditingDestinationIndex = -1)" />
                            </div>
                        }
                        else
                        {
                            <div class="flex-grow-1 d-flex align-items-center gap-2">
                                <DestinationDisplay 
                                    Destination="@destination.Destination"
                                    Destinations="@Destinations"
                                    AvailableStores="@AvailableStores"
                                    Truncate="true"
                                    ShowAliasIndicator="true" />
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        @onclick="@(() => EditingDestinationIndex = destIndex)"
                                        title="Change destination">
                                    Change
                                </button>
                            </div>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <input type="number" step="0.01" min="0" max="100" value="@destination.Percentage"
                                       @onchange="@((e) => UpdateDestinationValue(destination, e.Value))"
                                       class="form-control"
                                       placeholder="0"
                                       title="Percentage of the payment to send to this destination"/>
                                <span class="input-group-text">%</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    @onclick="@(() => RemoveDestination(destination))"
                                    title="Remove this destination">×</button>
                        }
                    </div>
                }
                @if (!Split.Destinations.Any())
                {
                    <p class="@(ShowValidationError ? "text-danger" : "text-muted") small mb-2">
                        @if (ShowValidationError)
                        {
                            <strong>At least one destination is required.</strong>
                        }
                        else
                        {
                            <text>No destinations configured. Add at least one destination to split payments.</text>
                        }
                    </p>
                }
                
                @if (IsAddingNewDestination)
                {
                    <div class="border rounded p-2 bg-light mb-2">
                        <DestinationPicker
                            StoreId="@StoreId"
                            Destinations="@Destinations"
                            AvailableStores="@AvailableStores"
                            PaymentMethodFilter="@GetPaymentMethodFilter()"
                            ValidateDestination="@ValidateDestination"
                            AllowEdit="true"
                            AllowSaveAsAlias="true"
                            OnSelect="@OnNewDestinationSelected"
                            OnAliasChange="@OnAliasChanged"
                            OnCancel="@(() => IsAddingNewDestination = false)" />
                    </div>
                }
                else
                {
                    <button type="button" class="btn btn-sm btn-link p-0" @onclick="StartAddingDestination">+ Add destination</button>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public Split Split { get; set; }
    [Parameter] public EventCallback<Split> OnRequestRemove { get; set; }
    [Parameter] public Func<Task<bool>> OnSave { get; set; }
    [Parameter] public Func<Task> OnSaveForce { get; set; }
    
    /// <summary>
    /// Store ID for the current store (needed for DestinationInput)
    /// </summary>
    [Parameter] public string StoreId { get; set; }
    
    /// <summary>
    /// Dictionary of alias -> PrismDestination for resolving and managing aliases
    /// </summary>
    [Parameter] public Dictionary<string, PrismDestination> Destinations { get; set; }
    
    /// <summary>
    /// List of available stores for store transfer destinations
    /// </summary>
    [Parameter] public List<SelectListItem> AvailableStores { get; set; }
    
    /// <summary>
    /// Validation function for raw destinations
    /// </summary>
    [Parameter] public Func<string, bool> ValidateDestination { get; set; }
    
    /// <summary>
    /// Callback when an alias is created/updated/deleted
    /// </summary>
    [Parameter] public EventCallback<DestinationPicker.AliasChangeEvent> OnAliasChange { get; set; }
    
    /// <summary>
    /// POS apps with products for the source editor
    /// </summary>
    [Parameter] public List<PosAppProductSplitModel> PosApps { get; set; }
    
    /// <summary>
    /// Lightning addresses for the source editor
    /// </summary>
    [Parameter] public List<LightningAddressData> LnAddresses { get; set; }

    private bool IsWalletTransfer => Split?.Source?.StartsWith("storetransfer:") == true;
    private bool IsPosSource => Split?.Source?.StartsWith("pos:") == true;
    private bool IsEditing { get; set; } = false;
    private bool ShouldShowEdit => IsEditing || !Split.Destinations.Any();

    private string WalletPaymentMethod { get; set; } = "BTC-CHAIN";
    private string WalletAmount { get; set; } = "";
    private string SelectedFrequency { get; set; } = "Monthly";
    private int SelectedDayValue { get; set; } = 1;
    
    // Destination editing state
    private int EditingDestinationIndex { get; set; } = -1;
    private bool IsAddingNewDestination { get; set; } = false;
    private bool ShowValidationError { get; set; } = false;

    private static readonly string[] DayNames = { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };

    protected override void OnParametersSet()
    {
        if (IsWalletTransfer)
        {
            ParseWalletSource();
        }
    }

    private void ParseWalletSource()
    {
        var parsed = SatBreaker.ParseSource(Split.Source);
        if (parsed.HasValue)
        {
            WalletPaymentMethod = parsed.Value.paymentMethod.ToString();
            WalletAmount = parsed.Value.amount?.ToUnit(LightMoneyUnit.Satoshi).ToString() ?? "";
            SelectedFrequency = parsed.Value.schedule.Frequency.ToString();
            SelectedDayValue = parsed.Value.schedule.DayValue;
        }
    }

    private async Task ToggleEdit()
    {
        if (IsEditing)
        {
            // Check if destinations exist before trying to save
            if (!Split.Destinations.Any())
            {
                ShowValidationError = true;
                return; // Can't save without destinations
            }
            
            ShowValidationError = false;
            
            // Closing edit mode - save changes
            var success = OnSave != null ? await OnSave.Invoke() : true;
            if (!success)
            {
                ShowValidationError = true;
                return; // Don't close if save/validation failed
            }
            // Reset editing state
            EditingDestinationIndex = -1;
            IsAddingNewDestination = false;
        }
        IsEditing = !IsEditing;
    }

    private void OnFrequencyChanged()
    {
        // Reset day value to sensible default when frequency changes
        SelectedDayValue = SelectedFrequency switch
        {
            "Weekly" => 1, // Monday
            "Monthly" => 1, // 1st of month
            _ => 1
        };
        UpdateWalletSource();
    }

    private void UpdateWalletSource()
    {
        LightMoney amount = null;
        if (!string.IsNullOrWhiteSpace(WalletAmount) && long.TryParse(WalletAmount, out var sats) && sats > 0)
        {
            amount = LightMoney.Satoshis(sats);
        }

        var frequency = Enum.Parse<SatBreaker.TransferFrequency>(SelectedFrequency);
        var schedule = new SatBreaker.TransferSchedule(frequency, SelectedDayValue);
        Split.Source = SatBreaker.EncodeSource(schedule, PaymentMethodId.Parse(WalletPaymentMethod), amount);
    }

    private string GetScheduleDisplayText()
    {
        return SelectedFrequency switch
        {
            "Daily" => "Daily",
            "Weekly" => $"Weekly on {DayNames[SelectedDayValue]}",
            "Monthly" => $"Monthly on {SelectedDayValue}{GetOrdinalSuffix(SelectedDayValue)}",
            _ => "Unknown"
        };
    }

    private static string GetOrdinalSuffix(int day)
    {
        if (day >= 11 && day <= 13) return "th";
        return (day % 10) switch
        {
            1 => "st",
            2 => "nd",
            3 => "rd",
            _ => "th"
        };
    }

    private string GetPaymentMethodFilter()
    {
        // For wallet transfers, filter by the selected payment method
        if (IsWalletTransfer)
        {
            return WalletPaymentMethod;
        }
        // For regular splits, no filter (allow all types)
        return null;
    }

    private void StartAddingDestination()
    {
        IsAddingNewDestination = true;
        EditingDestinationIndex = -1;
        ShowValidationError = false; // Clear error when user starts adding
    }

    private void StartEditingDestination(Prism.PrismSplit destination)
    {
        if (!ShouldShowEdit)
        {
            // If in read-only mode and clicking an alias, enter edit mode
            IsEditing = true;
        }
        EditingDestinationIndex = Split.Destinations.IndexOf(destination);
        IsAddingNewDestination = false;
    }

    private void OnDestinationSelected(Prism.PrismSplit destination, DestinationPicker.DestinationPickerResult result)
    {
        // Only update if we have a valid destination
        if (!string.IsNullOrEmpty(result?.Destination))
        {
            destination.Destination = result.Destination;
        }
        EditingDestinationIndex = -1;
    }

    private void OnNewDestinationSelected(DestinationPicker.DestinationPickerResult result)
    {
        var usedPercentage = Split.Destinations.Sum(d => d.Percentage);
        var remaining = Math.Max(0, 100 - usedPercentage);
        
        Split.Destinations.Add(new Prism.PrismSplit 
        { 
            Destination = result.Destination,
            Percentage = remaining 
        });
        
        IsAddingNewDestination = false;
    }

    private async Task OnAliasChanged(DestinationPicker.AliasChangeEvent evt)
    {
        if (OnAliasChange.HasDelegate)
        {
            await OnAliasChange.InvokeAsync(evt);
        }
    }

    private void RemoveSplit() => OnRequestRemove.InvokeAsync(Split);

    private void RemoveDestination(Prism.PrismSplit destination)
    {
        Split.Destinations.Remove(destination);
    }

    private void SendNow()
    {
        if (IsWalletTransfer && !string.IsNullOrEmpty(Split.Source))
        {
            EventAggregator.Publish(new SatBreaker.ScheduleDayEvent(forceSplitSource: Split.Source));
        }
    }

    private void UpdateDestinationValue(Prism.PrismSplit destination, object eValue)
    {
        var newValue = Math.Max(0, Math.Min(100, Math.Round(Convert.ToDecimal(eValue), 2)));
        var leftover = 100 - Split.Destinations.Sum(d => d.Percentage);
        var allowedMax = Math.Round(destination.Percentage + leftover, 2);

        if (newValue > allowedMax)
        {
            var difference = Math.Round(newValue - allowedMax, 2);
            var others = Split.Destinations.Where(d => d != destination).ToList();
            var total = Math.Round(others.Sum(d => d.Percentage), 2);
            foreach (var other in others)
            {
                other.Percentage = Math.Round(other.Percentage - (other.Percentage / total * difference), 2);
            }
        }
        destination.Percentage = newValue;
    }

    private void OnSourceChanged(string newSource)
    {
        Split.Source = newSource;
    }

    private string GetSourceTypeBadge()
    {
        if (string.IsNullOrEmpty(Split?.Source)) return "Split";
        if (Split.Source.StartsWith("storetransfer:")) return "Wallet Transfer";
        if (Split.Source.StartsWith("pos:")) return "POS";
        if (Split.Source.StartsWith("*")) return "Catch-all";
        return "LN Address";
    }

    private string GetSourceDisplayText()
    {
        if (string.IsNullOrEmpty(Split?.Source)) return "(not configured)";
        
        // Wallet transfer - show schedule info
        if (Split.Source.StartsWith("storetransfer:"))
        {
            return GetScheduleDisplayText();
        }
        
        // POS source - show friendly name
        if (Split.Source.StartsWith("pos:"))
        {
            var parts = Split.Source.Split(':');
            if (parts.Length >= 3)
            {
                var appId = parts[1];
                var productId = parts[2];
                var paymentFilter = parts.Length >= 4 ? parts[3] : null;
                
                var app = PosApps?.FirstOrDefault(a => a.AppId == appId);
                var product = app?.Products.FirstOrDefault(p => p.ProductId == productId);
                
                var displayText = product != null 
                    ? $"{app.AppTitle} / {product.Title}"
                    : $"{appId} / {productId}";
                    
                if (!string.IsNullOrEmpty(paymentFilter))
                {
                    displayText += paymentFilter == "BTC-LN" ? " (LN only)" : " (On-chain only)";
                }
                
                return displayText;
            }
        }
        
        // Catch-all - show friendly name
        if (Split.Source == "*") return "All Lightning payments";
        if (Split.Source == "*CHAIN") return "All On-chain payments";
        if (Split.Source == "*All") return "All payments";
        if (Split.Source.StartsWith("*")) return $"All {Split.Source[1..]} payments";
        
        // Lightning address - show as-is
        return Split.Source;
    }
}
