@using BTCPayServer.Plugins.Prism.ViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@using LightningAddressData = BTCPayServer.Data.LightningAddressData

@*
    Universal source editor component that handles all source types:
    - Lightning Address / LNURL (username or full address)
    - Catch-all (* for LN, *CHAIN for on-chain, *All for both)
    - POS Product (pos:{appId}:{productId}[:paymentMethod])
    - Wallet Transfer (storetransfer:{paymentMethod}:{amount}:{schedule}) - handled separately by PrismSplit
*@

<div class="source-editor">
    <div class="mb-2">
        <label class="form-label small mb-1">Source Type</label>
        <select class="form-select form-select-sm" @bind="SourceType" @bind:after="OnSourceTypeChanged">
            <option value="catchall">Catch-all</option>
            <option value="lnaddress">Lightning Address / LNURL</option>
            @if (PosApps?.Any() == true)
            {
                <option value="pos">POS Product</option>
            }
        </select>
    </div>

    @switch (SourceType)
    {
        case "catchall":
            <div class="mb-2">
                <label class="form-label small mb-1">Payment Method</label>
                <select class="form-select form-select-sm" @bind="CatchAllType" @bind:after="UpdateSource">
                    @foreach (var pm in EffectiveCatchAllMethods)
                    {
                        <option value="@pm.Value">@pm.Text</option>
                    }
                </select>
                <small class="text-muted">Catch all payments of the selected type made to invoices in your store.</small>
            </div>
            break;

        case "lnaddress":
            <div class="mb-2">
                <label class="form-label small mb-1">Address</label>
                <input type="text" class="form-control form-control-sm" 
                       @bind="LnAddress" @bind:after="UpdateSource"
                       list="users"
                       placeholder="username or user@domain.com" />
                <small class="text-muted">Split payments received via this lightning address or LNURL.</small>
            </div>
            break;

        case "pos":
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label small mb-1">POS App</label>
                    <select class="form-select form-select-sm" @bind="SelectedAppId" @bind:after="OnAppChanged">
                        <option value="">Select app...</option>
                        @foreach (var app in PosApps ?? Enumerable.Empty<PosAppProductSplitModel>())
                        {
                            <option value="@app.AppId">@app.AppTitle</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small mb-1">Product</label>
                    <select class="form-select form-select-sm" @bind="SelectedProductId" @bind:after="UpdateSource" 
                            disabled="@(string.IsNullOrEmpty(SelectedAppId))">
                        <option value="">Select product...</option>
                        @if (SelectedApp != null)
                        {
                            @foreach (var product in SelectedApp.Products)
                            {
                                <option value="@product.ProductId">@product.Title (@product.Price @product.Currency)</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small mb-1">Payment Filter</label>
                    <select class="form-select form-select-sm" @bind="PosPaymentFilter" @bind:after="UpdateSource"
                            disabled="@(string.IsNullOrEmpty(SelectedProductId))">
                        <option value="">Any payment</option>
                        @foreach (var pm in EffectivePaymentFilters)
                        {
                            <option value="@pm.Value">@pm.Text</option>
                        }
                    </select>
                </div>
            </div>
            <small class="text-muted mt-1 d-block">Split payments when this POS product is purchased.</small>
            break;
    }
</div>

@code {
    [Parameter] public string Source { get; set; }
    [Parameter] public EventCallback<string> SourceChanged { get; set; }
    [Parameter] public List<PosAppProductSplitModel> PosApps { get; set; }
    [Parameter] public List<LightningAddressData> LnAddresses { get; set; }
    
    /// <summary>
    /// Available payment methods for catch-all sources. If not provided, defaults to LN/Chain/All.
    /// </summary>
    [Parameter] public List<SelectListItem> CatchAllPaymentMethods { get; set; }
    
    /// <summary>
    /// Available payment methods for POS filters. If not provided, defaults to LN/Chain.
    /// </summary>
    [Parameter] public List<SelectListItem> PaymentMethodFilters { get; set; }
    
    private static readonly List<SelectListItem> DefaultCatchAllMethods = new()
    {
        new SelectListItem { Value = "*", Text = "Lightning only" },
        new SelectListItem { Value = "*CHAIN", Text = "On-chain only" },
        new SelectListItem { Value = "*All", Text = "All payments" }
    };
    
    private static readonly List<SelectListItem> DefaultPaymentFilters = new()
    {
        new SelectListItem { Value = "BTC-LN", Text = "Lightning only" },
        new SelectListItem { Value = "BTC-CHAIN", Text = "On-chain only" }
    };
    
    // Use provided lists or fall back to defaults
    private List<SelectListItem> EffectiveCatchAllMethods => CatchAllPaymentMethods?.Any() == true ? CatchAllPaymentMethods : DefaultCatchAllMethods;
    private List<SelectListItem> EffectivePaymentFilters => PaymentMethodFilters?.Any() == true ? PaymentMethodFilters : DefaultPaymentFilters;

    private string SourceType { get; set; } = "catchall";
    
    // Catch-all state
    private string CatchAllType { get; set; } = "*";
    
    // Lightning address state
    private string LnAddress { get; set; } = "";
    
    // POS state
    private string SelectedAppId { get; set; } = "";
    private string SelectedProductId { get; set; } = "";
    private string PosPaymentFilter { get; set; } = "";
    
    private PosAppProductSplitModel SelectedApp => PosApps?.FirstOrDefault(a => a.AppId == SelectedAppId);

    protected override void OnParametersSet()
    {
        ParseSource();
    }

    private void ParseSource()
    {
        if (string.IsNullOrEmpty(Source))
        {
            SourceType = "catchall";
            CatchAllType = "*";
            return;
        }

        // Wallet transfers are handled separately by PrismSplit
        if (Source.StartsWith("storetransfer:", StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        // POS source: pos:{appId}:{productId}[:paymentMethod]
        if (Source.StartsWith("pos:", StringComparison.OrdinalIgnoreCase))
        {
            SourceType = "pos";
            var parts = Source.Split(':');
            if (parts.Length >= 3)
            {
                SelectedAppId = parts[1];
                SelectedProductId = parts[2];
                PosPaymentFilter = parts.Length >= 4 ? parts[3] : "";
            }
            return;
        }

        // Catch-all: *, *CHAIN, *All, *LN, etc.
        if (Source.StartsWith("*"))
        {
            SourceType = "catchall";
            CatchAllType = Source;
            return;
        }

        // Otherwise it's a lightning address
        SourceType = "lnaddress";
        LnAddress = Source;
    }

    private async Task OnSourceTypeChanged()
    {
        // Reset to defaults when type changes
        switch (SourceType)
        {
            case "catchall":
                CatchAllType = "*";
                break;
            case "lnaddress":
                LnAddress = "";
                break;
            case "pos":
                SelectedAppId = "";
                SelectedProductId = "";
                PosPaymentFilter = "";
                break;
        }
        await UpdateSource();
    }

    private async Task OnAppChanged()
    {
        SelectedProductId = "";
        PosPaymentFilter = "";
        await UpdateSource();
    }

    private async Task UpdateSource()
    {
        var newSource = SourceType switch
        {
            "catchall" => CatchAllType,
            "lnaddress" => LnAddress,
            "pos" when !string.IsNullOrEmpty(SelectedAppId) && !string.IsNullOrEmpty(SelectedProductId) =>
                string.IsNullOrEmpty(PosPaymentFilter) 
                    ? $"pos:{SelectedAppId}:{SelectedProductId}"
                    : $"pos:{SelectedAppId}:{SelectedProductId}:{PosPaymentFilter}",
            _ => ""
        };

        if (newSource != Source)
        {
            await SourceChanged.InvokeAsync(newSource);
        }
    }
}
